Include /usr/local/modsecurity/lib/modsecurity.conf

SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess Off
SecAuditEngine RelevantOnly
SecAuditLog /var/log/nginx/modsec_audit.log
SecAuditLogParts ABDEFHIJZ
SecAuditLogType Serial
SecAuditLogStorageDir /var/log/nginx
# Allow internal health/readiness probes
SecRule REQUEST_URI "@beginsWith /healthz" "phase:1,id:90001,pass,nolog,ctl:ruleEngine=DetectionOnly"
SecRule REQUEST_URI "@beginsWith /readyz" "phase:1,id:90002,pass,nolog,ctl:ruleEngine=DetectionOnly"
# Magento customer section cookie produces JSON that triggers SQLi rules; skip for this cookie
SecRule REQUEST_COOKIES:section_data_ids "@rx .+" \
  "phase:1,id:90003,pass,nolog,ctl:ruleRemoveTargetById=942200;REQUEST_COOKIES:section_data_ids,ctl:ruleRemoveTargetById=942260;REQUEST_COOKIES:section_data_ids"
# Customer sections API relies on section_data_ids cookie; let CRS inspect in detection-only mode to avoid false positives
SecRule REQUEST_URI "@beginsWith /customer/section/load" \
  "phase:1,id:90004,pass,nolog,ctl:ruleRemoveById=942200,ctl:ruleRemoveById=942260,ctl:ruleRemoveById=949110"

Include /etc/nginx/owasp-crs/crs-setup.conf
Include /etc/nginx/owasp-crs/rules/*.conf
