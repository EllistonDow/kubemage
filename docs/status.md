# Kubemage Blueprint 状态 (2025-11-29)

| Phase | 状态 | 关键交付 | 下一动作 |
| --- | --- | --- | --- |
| Phase 0 | 资料齐备 | `scripts/host-init.sh`, `docs/phase-0-checklist.md` | 在 bm-a 执行脚本并记录结果 |
| Phase 1 | 模板完成 | kubeadm config、Cilium/MetalLB/OpenEBS values、`docs/phase1-guide.md` | 复制 `phase1.env.example` → `phase1.env`，运行 `scripts/phase1-render.sh` 输出 `cluster/phase1/generated/` 后执行 kubeadm/Cilium/MetalLB/OpenEBS |
| Phase 2 | 模板完成 | GitOps/Argo、监控、安全 manifests + runbooks | 按 `docs/runbooks/gitops-bootstrap.md` 运行 `scripts/phase2-deploy.sh` 安装 Argo CD/监控栈，并用 `cluster/phase2/gitops/argo-root.yaml` 指向 `gitops/clusters/kubemage-prod` |
| Phase 3 | 进行中 | Percona/OpenSearch/RabbitMQ/Valkey/Edge 配置、备份 runbook | MinIO 已纳入 Argo CD（`gitops/platform/datastores/minio-app.yaml` + `minio-secret.enc.yaml` 管理 root 凭据），并拆分 demo/bdgy IAM（`demoMediaUser`、`bdgyMediaUser`）；`scripts/shared-backup.sh` / `shared-monitor.sh` 已支持 Kubernetes 集群（`SHARED_BACKEND=k8s` 自动选择 Pod），新增 `scripts/shared-backup-run.sh`/`make shared-backup-run` 并在 2025-11-29 UTC 04:30 生成首批日志（`artifacts/phase3/20251129-043022z-shared-backup/`）；`cluster/operations/shared-monitor/` 现提供 CronJob + RBAC + ConfigMap，已被 `gitops/clusters/kubemage-prod/kustomization.yaml` 纳管以每 30 分钟巡检 Percona/OpenSearch，并可用 `scripts/shared-monitor-run.sh`/`make shared-monitor-run` 生成一次性日志；下一步要把 `shared-monitor` 输出纳入 Alertmanager/Telegram，并补齐 Valkey/RabbitMQ 指标与 `artifacts/phase3/` 例证 |
| Phase 4 | 持续推进 | Magento Helm chart、Namespace policies、部署 runbook | demo/bdgy 站点通过 `ingress-nginx` + Let's Encrypt 上线（`magento.k8s.bdgyoo.com` / `bdgy.k8s.bdgyoo.com`），Chart 已内建 Varnish Deployment/Service 并默认在 namespace 内暴露 `varnish:6081`、支持 `varnish.purgeCIDRs` 及「404 不缓存」策略；新增证书轮换 runbook（`docs/runbooks/cert-rotation.md`）+ `scripts/cert-rotation.sh`/`make cert-rotation` 并完成 demo 站点轮换（`artifacts/phase4/20251129-043850Z-cert-rotation/`）；KEDA manifests（`cluster/phase4/namespaces/demo-keda*.yaml`）已改为通过 `TriggerAuthentication` Secret 注入 RabbitMQ `host`/`vhostName`，并由 `gitops/tenants/demo/kustomization.yaml` 纳管以驱动 `demo-magento-consumer-async-bulk`；下一步完成 RabbitMQ/KEDA 阈值与 `async.operations.all` 队列验收、按 runbook 固化 TLS 演练 `artifacts/phase4/` 佐证、以及 Argo 根应用迁移（`platform/`→`gitops/platform`）的最终同步 |
| Phase 5 | 模板完成 | Longhorn/Velero configs、扩容/升级 runbooks、SLO/容量文档 | 引入第二台裸机、上线分布式存储、执行演练 |

所有文档位于 `docs/`，可在 Git 仓库中提交并推送。执行过程中请将验证结果（sonobuoy、备份、性能测试）存入 `artifacts/` 目录（尚待创建）。
