apiVersion: batch/v1
kind: CronJob
metadata:
  name: shared-backup
  namespace: ops
spec:
  schedule: "0 3 * * *"
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: shared-backup
          restartPolicy: Never
          containers:
            - name: backup
              image: dtzar/helm-kubectl:3.13.3
              imagePullPolicy: IfNotPresent
              command:
                - /bin/bash
                - -c
                - |
                  set -euo pipefail
                  JOB_NAME="shared-backup"
                  notify() {
                    if [ -z "${TELEGRAM_BOT_TOKEN:-}" ] || [ -z "${TELEGRAM_CHAT_ID:-}" ]; then
                      return
                    fi
                    if ! command -v curl >/dev/null 2>&1; then
                      echo "[${JOB_NAME}] curl 不存在，跳过 Telegram 通知" >&2
                      return
                    fi
                    local text="$1"
                    curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                      -d chat_id="${TELEGRAM_CHAT_ID}" \
                      -d text="$text" >/dev/null || true
                  }
                  trap 'notify "❌ [${JOB_NAME}] 备份失败 (exit $?) at $(date -u +%F_%T)"; exit 1' ERR
                  /opt/scripts/shared-backup.sh
                  notify "✅ [${JOB_NAME}] 完成 at $(date -u +%F_%T)"
              env:
                - name: BACKUP_ROOT
                  value: /backups
                - name: SNAPSHOT_ROOT
                  value: /snapshots
                - name: SHARED_BACKEND
                  value: k8s
                - name: PERCONA_NAMESPACE
                  value: databases
                - name: OPENSEARCH_NAMESPACE
                  value: search
                - name: OPENSEARCH_SELECTOR
                  value: app=opensearch
                - name: OPENSEARCH_K8S_CONTAINER
                  value: opensearch
                - name: PERCONA_SELECTOR
                  value: app.kubernetes.io/instance=percona-cluster-pxc-d
                - name: PERCONA_K8S_CONTAINER
                  value: pxc
                - name: OPENSEARCH_ENDPOINT
                  value: http://opensearch.search.svc.cluster.local:9200
                - name: PERCONA_ROOT_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: shared-backup-secrets
                      key: PERCONA_ROOT_PASSWORD
                - name: TELEGRAM_BOT_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: shared-backup-secrets
                      key: TELEGRAM_BOT_TOKEN
                - name: TELEGRAM_CHAT_ID
                  valueFrom:
                    secretKeyRef:
                      name: shared-backup-secrets
                      key: TELEGRAM_CHAT_ID
              volumeMounts:
                - name: script
                  mountPath: /opt/scripts
                  readOnly: true
                - name: backup
                  mountPath: /backups
                - name: snapshots
                  mountPath: /snapshots
          volumes:
            - name: script
              configMap:
                name: shared-backup-script
                defaultMode: 0755
            - name: backup
              persistentVolumeClaim:
                claimName: shared-backup
            - name: snapshots
              persistentVolumeClaim:
                claimName: shared-opensearch-snapshots
